## Training
In AFM-Fold, a CNN is trained to learn the correspondence between AFM images and the collective variables (CVs) of the underlying structures.  
The following code examples illustrate how to generate noiseless training data from MD conformations of Adenylate Kinase, and then train the CNN.

1. **Prepare a candidate conformation set**  
    In the paper, diverse structures were generated by running AlphaFold 3 with various restraints (see `notebooks/example.ipynb` to check how to add restraints on AlphaFold 3).
    Candidate conformation set can also be extracted from long MD simulations.

2. **Compute CVs corresponding to the trajectory**  
    For example, to compute inter-domain distances as in the paper, you can use:

    ```python
    import mdtraj as md
    import numpy as np
    from afmfold.domain import get_domain_pairs, compute_domain_distance

    # Load the candidate conformation set
    traj = md.load("storage/ak.dcd", top="storage/ak.pdb")

    # Get domain pairs (list of tuples, each containing two numpy arrays of residue indices)
    domain_pairs = get_domain_pairs("4ake")

    # Compute inter-domain distances
    domain_distance = np.zeros((len(traj), len(domain_pairs)))
    for i, (d1, d2) in enumerate(domain_pairs):
        domain_distance[:, i] = compute_domain_distance(traj, d1, d2).ravel()

    # Save the result
    np.save("storage/ak_distance.npy", domain_distance)
    ```

3. **Generate training data** using `scripts/generate_images.py`:

    ```bash
    # Prepare output directories
    mkdir -p data/ak

    # Generate AFM images and labels (epochs * dataset_size data points)
    nohup python scripts/generate_images.py \
        --save-dir data/ak/ \
        --pdb-path storage/ak.pdb \
        --dcd-path storage/ak.dcd \
        --distance-path storage/ak_distance.npy \
        --width 35 --height 35 \
        --resolution-nm 0.3 \
        --min-tip-radius 1.0 --max-tip-radius 2.0 \
        --noise-nm 0.0 \
        --device cuda \
        --epochs 500 \
        --dataset-size 10000 \
        > images.log 2>&1 &

    # Check results (image_0-499.npy, label_0-499.npy should be created)
    ls data/ak/
    ```

4. **Train the CNN** using `scripts/train.py`:

    ```bash
    # Create output directory for trained models
    mkdir -p models/ak

    # Train the CNN
    nohup python scripts/train.py \
        --data-dir data/ak/ \
        --output-root models/ak/ \
        --epochs 500 \
        --device cuda \
        > train.log 2>&1 &
    ```
    After training, the model checkpoints and loss functions will be stored in `models/ak/`.

## Inference
Inference can be run either in `notebooks/example.ipynb` or directly via `scripts/inference.py`:

```bash
# Generate json file with the MSA path.
afmfold tojson --input ./storage/4ake.pdb --out_dir ./storage
afmfold msa --input ./storage/4ake-without-msa.json --out_dir ./storage
ls ./storage

# Run inference.
nohup python scripts/inference.py \
    --image-path path/to/afm_images \
    --ckpt path/to/your_model.pt \
    --json-path ./storage/4ake-with-msa.json \
    --out-dir out/inference/ \
    --device cuda \
    > inference.log 2>&1 &
```
